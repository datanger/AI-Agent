### **实时电子表格变更监控工具 - 需求文档**

**版本:** 1.0
**日期:** 2025年7月29日

---

#### **1. 引言**

**1.1 项目背景**
在团队协作和数据管理中，经常需要追踪电子表格（如 `.xlsx` 文件）的内容变更。传统的手动比对或定期检查方法效率低下、容易出错，且无法满足实时性要求。为了解决这一痛点，需要开发一个自动化工具，能够实时监控电子表格的单元格级别变更，并生成清晰的事件日志。

**1.2 项目目标**
本项目旨在开发一个后台监控工具，实现以下核心目标：
*   **实时性**：在用户对单元格进行修改（而非等到文件保存）的瞬间，立即捕获变更。
*   **精确性**：准确识别单元格级别的“创建”、“更新”、“删除”操作。
*   **日志化**：将所有变更事件以统一、清晰的格式记录到日志文件中，形成审计追踪。
*   **跨平台/应用支持**：工具需支持在主流操作系统（Windows, Ubuntu Linux）上，针对最常用的电子表格软件（Microsoft Excel, WPS Office, LibreOffice）进行监控。

**1.3 目标用户**
*   需要对共享文件进行审计的数据管理员。
*   需要追踪项目计划、预算表等关键文件变更的项目经理。
*   任何需要在协作环境中对电子表格变更保持敏感和追踪的用户。

---

#### **2. 项目范围**

**2.1 范围内 (In Scope)**
*   监控单个预先配置好的 `.xlsx` 文件。
*   实时检测单元格内容的**值**变更。
*   识别并记录三种基本事件：单元格创建（从无到有）、单元格更新（值变化）、单元格删除（从有到无）。
*   支持以下平台与应用的组合：
    *   **Windows**: Microsoft Excel
    *   **Windows**: WPS Spreadsheets (ET)
    *   **Ubuntu Linux**: LibreOffice Calc
*   变更事件将被记录在本地的 `excel_monitor.log` 文件中。
*   工具以命令行脚本的形式运行，无图形用户界面（GUI）。

**2.2 范围外 (Out of Scope)**
*   同时监控多个文件。
*   监控单元格的格式变更（如颜色、字体、边框等）。
*   监控图表、图片、宏、公式依赖关系等非单元格值的内容。
*   提供用户管理、权限控制等功能。
*   为监控工具本身提供图形用户界面。
*   对 macOS 平台的支持。

---

#### **3. 功能需求 (Functional Requirements)**

| ID | 需求描述 | 详细说明 |
| :--- | :--- | :--- |
| **FR-1** | **实时变更检测** | 系统必须在用户于电子表格软件中完成一次单元格修改操作（如输入值后按 Enter 或焦点离开单元格）的瞬间，捕获到该事件。 |
| **FR-2** | **变更类型识别** | 系统必须能够准确区分以下三种变更类型： |
| FR-2.1 | 单元格创建 | 当一个原本为空的单元格被赋予了值。 |
| FR-2.2 | 单元格更新 | 当一个已有值的单元格被修改为另一个不同的值。 |
| FR-2.3 | 单元格删除 | 当一个已有值的单元格内容被清空。 |
| **FR-3** | **事件日志记录** | 所有检测到的变更必须被记录下来。 |
| FR-3.1 | 日志格式 | 日志条目必须包含：时间戳、日志级别、被监控的文件名、工作表名、事件类型、单元格地址（如 `$A$1`）、以及值的变化详情（如 `from '旧值' to '新值'`）。 |
| FR-3.2 | 日志存储 | 日志必须追加写入到项目根目录下的 `excel_monitor.log` 文件中。 |
| **FR-4** | **平台与应用兼容性** | 系统必须提供针对不同环境的独立解决方案。 |
| FR-4.1 | Windows - MS Excel | 必须能通过连接到 `Excel.Application` 来监控 Microsoft Excel。 |
| FR-4.2 | Windows - WPS Office | 必须能通过连接到 `et.Application` 来监控 WPS Spreadsheets。 |
| FR-4.3 | Ubuntu - LibreOffice | 必须能通过连接到一个后台 LibreOffice 进程来监控 LibreOffice Calc。 |

---

#### **4. 非功能需求 (Non-Functional Requirements)**

| ID | 需求描述 | 详细说明 |
| :--- | :--- | :--- |
| **NFR-1** | **性能** | 监控脚本在后台运行时，对用户前台操作电子表格软件的性能影响应降至最低，不应出现可感知的卡顿。 |
| **NFR-2** | **可靠性** | 监控脚本必须能够稳定运行，并能正确处理电子表格应用的启动和关闭。在脚本退出时，必须确保其启动的后台进程（如 LibreOffice）能被干净地终止。 |
| **NFR-3** | **可用性** | 用户通过简单的命令行指令即可启动监控。脚本的输出信息应清晰易懂，能指导用户进行下一步操作（如打开文件、按 Ctrl+C 停止等）。 |

---

#### **5. 技术架构与实现**

**5.1 核心架构**
本项目采用**事件驱动架构**。放弃了低效且无法满足实时性的文件轮询或文件系统监控 (`inotify`) 方案，转而使用各办公软件套件提供的**原生二次开发接口 (API)**。通过这些 API，监控脚本可以将自己注册为应用程序的“监听器”，由应用程序在事件发生时主动通知脚本，从而实现真正的实时监控。

**5.2 Windows 平台实现**
*   **核心技术**: **COM Automation**
*   **关键库**: `pywin32`
*   **实现机制**:
    1.  使用 `win32com.client.DispatchWithEvents` 方法，根据程序标识符 (`Excel.Application` 或 `et.Application`) 启动或连接到目标应用。
    2.  创建一个 Python 类作为事件处理器，并将其绑定到应用程序的 `OnSheetChange` 事件上。
    3.  当用户修改单元格时，应用程序触发事件，自动调用 Python 事件处理器中的相应方法，并传入发生变更的工作表和单元格范围 (`target`) 对象。
    4.  脚本主进程通过 `pythoncom.PumpMessages()` 消息循环来持续接收事件。

**5.3 Ubuntu Linux 平台实现**
*   **核心技术**: **LibreOffice UNO (Universal Network Objects) API**
*   **关键库**: `uno` (通常随 `libreoffice-script-provider-python` 一同安装)
*   **实现机制**:
    1.  在后台启动一个“无头”的 LibreOffice 进程，并让其在指定端口上监听 UNO 连接请求。
    2.  Python 脚本通过 Socket 连接到该 UNO 端口，获取对后台进程的控制权 (`Desktop` 对象)。
    3.  脚本命令后台进程加载目标文档。
    4.  为文档中的每个工作表创建一个实现了 `XModifyListener` 接口的 Python 监听器对象，并将其附加到工作表上。
    5.  当工作表内容变更时，LibreOffice 会自动调用监听器中的 `modified` 方法，脚本从而得知变更发生。
